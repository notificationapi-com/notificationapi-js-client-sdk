!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NotificationAPI=t():e.NotificationAPI=t()}(this,(()=>(()=>{"use strict";var e,t,n={d:(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},i={};n.d(i,{default:()=>s}),function(e){e.AUTOMATIC="AUTOMATIC",e.MANUAL="MANUAL"}(e||(e={})),function(e){e.TopLeft="topLeft",e.TopRight="topRight",e.LeftTop="leftTop",e.LeftBottom="leftBottom",e.BottomLeft="bottomLeft",e.BottomRight="bottomRight",e.RightTop="rightTop",e.RightBottom="rightBottom"}(t||(t={}));var a=function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{r(i.next(e))}catch(e){o(e)}}function c(e){try{r(i.throw(e))}catch(e){o(e)}}function r(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}r((i=i.apply(e,t||[])).next())}))},o=function(e,t){var n,i,a,o,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function c(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(a=2&o[0]?i.return:o[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,o[1])).done)return a;switch(i=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!((a=(a=s.trys).length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){s.label=o[1];break}if(6===o[0]&&s.label<a[1]){s.label=a[1],a=o;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(o);break}a[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],i=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}};const s=function(){function n(n){var i,a=this;if(this.destroy=function(){var e;null===(e=a.websocket)||void 0===e||e.close(),Object.values(a.elements).map((function(e){e&&e.remove()}))},this.showInApp=function(n){var i;a.state.inappOptions=n;var o=document.getElementById(n.root);if(o)if(a.elements.root=o,!n.popupPosition||Object.values(t).includes(n.popupPosition)){o.hasChildNodes()&&(o.innerHTML="");var s=document.createElement("div");s.classList.add("notificationapi-container"),o.appendChild(s),a.elements.popup=document.createElement("div");var c=a.elements.popup;if(c.classList.add("notificationapi-popup"),n.inline)c.classList.add("inline");else{c.classList.add("popup"),c.classList.add("hovering"),c.classList.add("closed");var r=document.createElement("button");r.classList.add("notificationapi-button"),r.innerHTML='<span class="icon-bell-o"></span>',s.appendChild(r),r.onclick=function(){c.classList.contains("closed")?a.openInAppPopup():a.closeInAppPopup()},a.elements.button=r,window.addEventListener("click",(function(e){var t,n,i,o=null!==(t=e.target.closest(".notificationapi-popup"))&&void 0!==t&&t,s=null!==(n=e.target.closest(".notificationapi-button"))&&void 0!==n&&n,r=null!==(i=e.target.closest(".notificationapi-preferences-container"))&&void 0!==i&&i;s||o||r||a.elements.notificationMenu||c.classList.add("closed")}));var d=document.createElement("div");d.classList.add("notificationapi-unread"),r.appendChild(d),a.elements.unread=d,a.setInAppUnread(a.state.unread)}s.appendChild(c),window.addEventListener("click",(function(e){var t;(null===(t=e.target.closest(".notificationapi-notification-menu-button"))||void 0===t||!t)&&a.elements.notificationMenu&&(a.elements.notificationMenu.remove(),a.elements.notificationMenu=void 0)})),a.elements.popupInner=document.createElement("div");var p=a.elements.popupInner;p.classList.add("notificationapi-popup-inner"),c.appendChild(p),a.elements.popupInner=p,a.elements.header=document.createElement("div");var l=document.createElement("button");l.classList.add("notificationapi-close-button"),l.addEventListener("click",(function(){a.closeInAppPopup()})),a.elements.header.appendChild(l);var u=document.createElement("h1");u.innerHTML="Notifications",a.elements.header.appendChild(u);var f=document.createElement("button");if(f.classList.add("notificationapi-preferences-button"),f.innerHTML='<span class="icon-cog"></span>',f.title="Notification Settings",f.addEventListener("click",(function(){a.showUserPreferences()})),a.elements.header.appendChild(f),n.markAsReadMode===e.MANUAL){var h=document.createElement("button");h.classList.add("notificationapi-readAll-button"),h.innerHTML='<span class="icon-check"></span>',h.title="Mark all as read",h.addEventListener("click",(function(){a.readAll()})),a.elements.header.appendChild(h)}a.elements.header.classList.add("notificationapi-header"),p.appendChild(a.elements.header);var m=document.createElement("div");if(m.classList.add("notificationapi-empty"),m.innerHTML="You don't have any notifications!",p.appendChild(m),a.elements.empty=m,a.elements.footer=document.createElement("div"),n.paginated){a.state.pageSize=null!==(i=n.pageSize)&&void 0!==i?i:5;var v=document.createElement("button");v.classList.add("notificationapi-prev-button"),v.innerHTML="<",v.disabled=!0,v.addEventListener("click",(function(){a.changePage(a.state.currentPage-1)})),a.elements.prevButton=v;var g=document.createElement("button");g.classList.add("notificationapi-next-button"),g.innerHTML=">",g.disabled=!0,g.addEventListener("click",(function(){a.changePage(a.state.currentPage+1)})),a.elements.nextButton=g,a.elements.footer.appendChild(v),a.elements.footer.appendChild(g)}a.elements.footer.classList.add("notificationapi-footer"),p.appendChild(a.elements.footer),a.addNotificationsToState(a.state.notifications),n.paginated||(p.onscroll=function(){p.scrollTop+p.clientHeight>=p.scrollHeight-100&&a.requestMoreNotifications()}),a.sendWSMessage({route:"inapp_web/unread_count"}),a.sendWSMessage({route:"inapp_web/notifications",payload:{count:50}}),a.websocket&&a.websocket.addEventListener("message",(function(e){var t=JSON.parse(e.data);if(t&&t.route){if("inapp_web/unread_count"===t.route){var n=t;a.websocketHandlers.unreadCount(n)}"inapp_web/notifications"===t.route&&(n=t,a.websocketHandlers.notifications(n)),"inapp_web/new_notifications"===t.route&&(n=t,a.websocketHandlers.newNotifications(n))}}))}else console.error('"'.concat(n.popupPosition,'" is not a valid position. Valid positions: ').concat(Object.values(t).join(", ")));else console.error('There are no HTML elements with id="'.concat(n.root,'" on the page.'))},this.elements={},this.state={initOptions:n,lastNotificationsRequestAt:0,notifications:[],unread:0,oldestNotificationsDate:"",currentPage:0,pageSize:999999},this.websocketHandlers={notifications:function(e){var t=e.payload.notifications;if(a.state.lastResponseNotificationsCount=t.length,a.addNotificationsToState(t),t.length<50&&!a.elements.empty&&a.elements.popupInner&&a.state.inappOptions&&!a.state.inappOptions.paginated){var n=document.createElement("div");n.innerHTML="No more notifications to load",n.classList.add("notificationapi-nomore"),a.elements.popupInner.append(n)}a.renderNotifications()},newNotifications:function(e){var t=a.state.notifications.length;a.addNotificationsToState(e.payload.notifications),a.renderNotifications();var n=a.state.notifications.length;a.setInAppUnread(a.state.unread+n-t)},unreadCount:function(e){a.setInAppUnread(e.payload.count)}},n.clientId&&"undefined"!==n.clientId)if(n.userId&&"undefined"!==n.userId){if(!1!==n.websocket){var o="".concat(null!==(i=n.websocket)&&void 0!==i?i:"wss://ws.notificationapi.com","?envId=").concat(encodeURIComponent(n.clientId),"&userId=").concat(encodeURIComponent(n.userId)).concat(n.userIdHash?"&userIdHash="+encodeURIComponent(n.userIdHash):"");this.websocket=new WebSocket(o)}}else console.error("Invalid userId.");else console.error("Invalid clientId.")}return n.prototype.requestMoreNotifications=function(){if(this.websocket&&(new Date).getTime()-this.state.lastNotificationsRequestAt>=500&&(void 0===this.state.lastResponseNotificationsCount||this.state.lastResponseNotificationsCount>=50)){this.state.lastNotificationsRequestAt=(new Date).getTime();var e={route:"inapp_web/notifications",payload:{before:this.state.oldestNotificationsDate,count:50}};this.sendWSMessage(e)}},n.prototype.showUserPreferences=function(e){var t=this;if(this.elements.preferencesContainer)this.elements.preferencesContainer.classList.remove("closed");else{var n=document.getElementsByTagName("body")[0];if(null==e?void 0:e.parent){var i=document.getElementById(e.parent);i?n=i:console.error('There are no HTML elements with id="'.concat(e.parent,'" on the page.'))}var a=document.createElement("div");a.classList.add("notificationapi-preferences-container"),(null==e?void 0:e.parent)&&a.classList.add("inline"),this.elements.preferencesContainer=a,n.appendChild(a);var o=document.createElement("div");o.classList.add("notificationapi-preferences-backdrop"),o.addEventListener("click",(function(){a.classList.add("closed")})),a.appendChild(o);var s=document.createElement("div");s.classList.add("notificationapi-preferences-popup"),a.appendChild(s),this.elements.preferencesPopup=s;var c=document.createElement("button");c.classList.add("notificationapi-preferences-close"),c.addEventListener("click",(function(){a.classList.add("closed")})),s.appendChild(c);var r=document.createElement("h1");r.innerHTML="Notification Preferences",s.appendChild(r);var d=document.createElement("div");d.classList.add("notificationapi-loading");var p=document.createElement("span");p.classList.add("icon-spinner8","spinner"),d.appendChild(p),s.appendChild(d),this.elements.preferencesLoading=d,this.websocket&&this.websocket.addEventListener("message",(function(e){var n=JSON.parse(e.data);if(n&&n.route&&"user_preferences/preferences"===n.route){var i=n;t.renderPreferences(i.payload.userPreferences)}}))}this.sendWSMessage({route:"user_preferences/get_preferences"})},n.prototype.getUserPreferences=function(){return a(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return this.sendWSMessage({route:"user_preferences/get_preferences"}),[4,this.websocketMessageReceived("user_preferences/preferences")];case 1:return[2,e.sent().payload.userPreferences]}}))}))},n.prototype.patchUserPreference=function(e,t,n,i){var a={route:"user_preferences/patch_preferences",payload:[{notificationId:e,channelPreferences:[{channel:t,state:n}]}]};i&&(a.payload[0].subNotificationId=i),this.sendWSMessage(a)},n.prototype.openInAppPopup=function(){var n,i,a,o,s,c,r,d,p,l,u;this.elements.popup&&this.elements.popupInner&&this.elements.button&&this.state.inappOptions&&!this.state.inappOptions.inline&&(i=this.elements.popup,a=this.elements.popupInner,o=this.elements.button,s=null!==(n=this.state.inappOptions.popupPosition)&&void 0!==n?n:t.RightBottom,c=s.toString(),r=document.documentElement.clientHeight+"px",d="auto",p="auto",l="auto",u="auto",window.innerWidth<768?(d=-o.getBoundingClientRect().top+"px",p=-(document.documentElement.clientHeight-o.getBoundingClientRect().bottom)+"px",l=-o.getBoundingClientRect().left+"px",u=-(document.documentElement.clientWidth-o.getBoundingClientRect().right)+"px"):(c.startsWith("top")&&(p=o.clientHeight+10+"px",r=o.getBoundingClientRect().top-20+"px"),c.startsWith("bottom")&&(p="auto",d=o.clientHeight+10+"px",r=window.innerHeight-o.getBoundingClientRect().bottom-40+"px"),c.startsWith("left")&&(l="auto",u=o.clientWidth+10+"px"),c.startsWith("right")&&(u="auto",l=o.clientWidth+10+"px"),c.endsWith("Top")&&(d="auto",p="0px",r=o.getBoundingClientRect().bottom-20+"px"),c.endsWith("Bottom")&&(p="auto",d="0px",r=window.innerHeight-o.getBoundingClientRect().top-40+"px"),c.endsWith("Left")&&(l="auto",u="0px"),c.endsWith("Right")&&(u="auto",l="0px")),i.style.top=d,i.style.bottom=p,i.style.left=l,i.style.right=u,a.style.maxHeight=r,this.elements.popup.classList.remove("closed"),this.state.inappOptions.markAsReadMode&&this.state.inappOptions.markAsReadMode!==e.AUTOMATIC||this.readAll())},n.prototype.readAll=function(){this.setInAppUnread(0),this.state.notifications.map((function(e){e.seen=!0})),this.sendWSMessage({route:"inapp_web/unread_clear"}),this.state.inappOptions&&this.state.inappOptions.markAsReadMode===e.MANUAL&&this.elements.popupInner&&this.elements.popupInner.querySelectorAll(".unseen").forEach((function(e){e.classList.remove("unseen")}))},n.prototype.closeInAppPopup=function(){this.elements.popup&&this.state.inappOptions&&!this.state.inappOptions.inline&&this.elements.popup.classList.add("closed")},n.prototype.setInAppUnread=function(e){this.state.unread=e,this.elements.unread&&this.state.inappOptions&&!this.state.inappOptions.inline&&(0===e?this.elements.unread.classList.add("hidden"):this.elements.unread.classList.remove("hidden"),this.elements.unread.innerHTML=e<100?e+"":"+99")},n.prototype.addNotificationsToState=function(e){var t=this,n=e.filter((function(e){return!t.state.notifications.find((function(t){return t.id===e.id}))}));this.state.notifications=this.state.notifications.concat(n),this.state.notifications.sort((function(e,t){return Date.parse(t.date)-Date.parse(e.date)})),this.state.notifications.length>0&&(this.state.oldestNotificationsDate=this.state.notifications[this.state.notifications.length-1].date),n.length>0&&this.elements.empty&&(this.elements.empty.remove(),delete this.elements.empty)},n.prototype.getPageCount=function(){return Math.max(1,Math.ceil(this.state.notifications.length/this.state.pageSize))},n.prototype.changePage=function(e){this.state.currentPage=e,this.state.currentPage>=this.getPageCount()-2&&this.requestMoreNotifications(),this.renderNotifications()},n.prototype.renderNotifications=function(){var e=this.elements.header,t=this.elements.popupInner;if(e&&t&&this.state.inappOptions){var n=this.state.currentPage,i=this.state.pageSize;this.state.inappOptions.paginated&&t.querySelectorAll(".notificationapi-notification").forEach((function(e){e.remove()}));for(var a=n*i;a<this.state.notifications.length&&a<n*i+i;a++){var o=this.state.notifications[a];if(!t.querySelector('[data-notification-id="'.concat(o.id,'"]'))){var s=this.generateNotificationElement(o);if(a===n*i)e.insertAdjacentElement("afterend",s);else{var c=t.querySelector('[data-notification-id="'.concat(this.state.notifications[a-1].id,'"]'));c?c.insertAdjacentElement("afterend",s):console.error("error finding previous notification",this.state.notifications[a-1])}}}this.elements.prevButton&&(this.elements.prevButton.disabled=0===n),this.elements.nextButton&&(this.elements.nextButton.disabled=n>=this.state.notifications.length/i-1)}},n.prototype.generateNotificationElement=function(t){var n=this,i=document.createElement("a");i.setAttribute("data-notification-id",t.id),i.classList.add("notificationapi-notification"),t.redirectURL&&(i.href=t.redirectURL);var a=document.createElement("div");if(a.classList.add("notificationapi-notification-imageContainer"),t.imageURL){var o=document.createElement("img");o.classList.add("notificationapi-notification-image"),o.src=t.imageURL,a.appendChild(o)}else{var s=document.createElement("span");s.classList.add("icon-commenting-o"),s.classList.add("notificationapi-notification-defaultIcon"),a.appendChild(s)}i.appendChild(a);var c=document.createElement("div");c.classList.add("notificationapi-notification-metaContainer");var r=document.createElement("p");r.classList.add("notificationapi-notification-title"),r.innerHTML=t.title,c.appendChild(r);var d=document.createElement("p");if(d.classList.add("notificationapi-notification-date"),d.innerHTML=function(e){if(e<0)return"just now";var t=Math.round(e)/1e3,n=Math.round(t/60),i=Math.round(t/3600),a=Math.round(t/86400),o=Math.round(t/2592e3),s=Math.round(t/9234e5);return s>0?"".concat(s," ").concat(1===s?"year":"years"," ago"):o>0?"".concat(o," ").concat(1===o?"month":"months"," ago"):a>0?"".concat(a," ").concat(1===a?"day":"days"," ago"):i>0?"".concat(i," ").concat(1===i?"hour":"hours"," ago"):n>0?"".concat(n," ").concat(1===n?"minute":"minutes"," ago"):"just now"}(Date.now()-new Date(t.date).getTime()),c.appendChild(d),i.appendChild(c),t.seen||i.classList.add("unseen"),this.state.inappOptions&&this.state.inappOptions.markAsReadMode===e.MANUAL){var p=document.createElement("button");p.classList.add("notificationapi-notification-menu-button"),p.innerHTML='<span class="icon-ellipsis-h"></span>',p.addEventListener("click",(function(e){var a;e.preventDefault(),null===(a=n.elements.notificationMenu)||void 0===a||a.remove();var o=document.createElement("div");o.classList.add("notificationapi-notification-menu");var s=document.createElement("button");s.classList.add("notificationapi-notification-menu-item"),s.innerHTML='<span class="icon-check"></span><span class="notificationapi-notification-menu-item-text">Mark as read</span>',s.addEventListener("click",(function(e){e.preventDefault(),i.classList.remove("unseen"),n.setInAppUnread(n.state.unread-1),n.sendWSMessage({route:"inapp_web/unread_clear",payload:{notificationId:t.id}})})),o.appendChild(s),i.appendChild(o),n.elements.notificationMenu=o})),i.appendChild(p)}return i},n.prototype.renderPreferences=function(e){var t,n,i=this;if(this.elements.preferencesPopup){null===(t=this.elements.preferencesLoading)||void 0===t||t.remove(),this.elements.preferencesLoading=void 0;var a=this.elements.preferencesPopup,o=e.filter((function(e){return e.settings.length>0}));if(0===o.length&&!this.elements.preferencesEmpty){var s=document.createElement("div");return s.classList.add("notificationapi-preferences-empty"),s.innerHTML="There are no notifications to configure.",a.appendChild(s),void(this.elements.preferencesEmpty=s)}null===(n=this.elements.preferencesGrid)||void 0===n||n.remove(),this.elements.preferencesGrid=void 0;var c=document.createElement("div");c.classList.add("notificationapi-preferences-grid"),this.elements.preferencesGrid=c,a.appendChild(c);var r={};o.map((function(e){e.settings.map((function(e){r[e.channel]||(r[e.channel]=e.channelName)}))}));var d=1;Object.values(r).map((function(e,t){var n=document.createElement("div");n.innerHTML=e,n.classList.add("notificationapi-preferences-channel","notificationapi-preferences-col".concat(t+2),"notificationapi-preferences-row".concat(d)),c.appendChild(n)})),d++,o.map((function(e){var t=document.createElement("div");if(t.classList.add("notificationapi-preferences-title","notificationapi-preferences-col1","notificationapi-preferences-row".concat(d)),t.innerHTML=e.title,c.appendChild(t),e.settings.map((function(t){var n=document.createElement("div"),a=Object.keys(r).indexOf(t.channel)+2;n.classList.add("notificationapi-preferences-toggle","notificationapi-preferences-col".concat(a),"notificationapi-preferences-row".concat(d)),n.setAttribute("data-notificationId",e.notificationId),n.setAttribute("data-channel",t.channel);var o=document.createElement("label");o.classList.add("switch"),n.appendChild(o);var s=document.createElement("input");s.setAttribute("type","checkbox"),s.checked=t.state,o.appendChild(s);var p=document.createElement("i");o.appendChild(p),s.addEventListener("change",(function(){c.querySelectorAll('.notificationapi-preferences-subtoggle[data-notificationid="'.concat(e.notificationId,'"][data-channel="').concat(t.channel,'"] input')).forEach((function(e){e.disabled=!s.checked})),i.patchUserPreference(e.notificationId,t.channel,s.checked)})),c.appendChild(n)})),d++,e.subNotificationPreferences&&e.subNotificationPreferences.length>0){var n=document.createElement("button");n.innerHTML="expand",n.setAttribute("data-notificationId",e.notificationId);var o=Object.keys(r).length+2;n.classList.add("notificationapi-preferences-expand","notificationapi-preferences-col".concat(o),"notificationapi-preferences-row".concat(d-1)),n.addEventListener("click",(function(e){var t=e.target.getAttribute("data-notificationId");a.querySelectorAll('[data-notificationId="'.concat(t,'"][data-subNotificationId]')).forEach((function(e){e.classList.toggle("closed")}))})),c.appendChild(n),e.subNotificationPreferences.map((function(t){var n=document.createElement("div");n.classList.add("notificationapi-preferences-subtitle","notificationapi-preferences-col1","notificationapi-preferences-row".concat(d),"closed"),n.setAttribute("data-subNotificationId",t.subNotificationId),n.setAttribute("data-notificationId",e.notificationId),n.innerHTML=t.title,c.appendChild(n),t.settings.map((function(n){var a=document.createElement("div"),o=Object.keys(r).indexOf(n.channel)+2;a.classList.add("notificationapi-preferences-subtoggle","notificationapi-preferences-col".concat(o),"notificationapi-preferences-row".concat(d),"closed"),a.setAttribute("data-notificationId",t.notificationId),a.setAttribute("data-subNotificationId",t.subNotificationId),a.setAttribute("data-channel",n.channel);var s=document.createElement("label");s.classList.add("switch","small"),a.appendChild(s);var p=document.createElement("input");p.setAttribute("type","checkbox"),p.checked=n.state,e.settings.find((function(e){return e.channel===n.channel&&!1===e.state}))&&(p.disabled=!0),s.appendChild(p);var l=document.createElement("i");s.appendChild(l),p.addEventListener("change",(function(){i.patchUserPreference(e.notificationId,n.channel,p.checked,t.subNotificationId)})),c.appendChild(a)})),d++}))}}))}},n.prototype.sendWSMessage=function(e){if(this.websocket){var t=this.websocket;t.readyState==t.OPEN?t.send(JSON.stringify(e)):t.addEventListener("open",(function(){t.send(JSON.stringify(e))}))}},n.prototype.websocketMessageReceived=function(e){return a(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,this.websocketOpened()];case 1:return t=n.sent(),[2,new Promise((function(n){t.addEventListener("message",(function(t){var i=JSON.parse(t.data);i&&i.route&&i.route===e&&n(i)}))}))]}}))}))},n.prototype.websocketOpened=function(){var e=this;return new Promise((function(t,n){if(e.websocket){var i=e.websocket;i.readyState==i.OPEN?t(i):i.addEventListener("open",(function(){t(i)}))}else n("Websocket is not present.")}))},n}();return i.default})()));